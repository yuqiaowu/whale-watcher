# 双 Tab 数据源差异分析与“数据总线”合并方案

## 1. 现状：数据源与数据流向

目前系统由两个核心页面组成，它们在后端共享底层数据，但在前端展示和数据结构上存在差异。

### Tab 1: 市场分析 (Market Analytics)
*   **定位**：全方位市场仪表盘，展示宏观、新闻、链上数据。
*   **核心数据源**：`global_onchain_news_snapshot.json`
*   **关键字段**：
    *   **新闻 (News)**: 来源于 Google Gemini 总结的 Crypto 资讯。
    *   **鲸鱼异动 (Whale Stats)**: ETH/SOL 链上大单、稳定币流向。
    *   **衍生品数据**: 全网爆仓量 (Liquidations)、合约持仓量。
    *   **情绪指标**: 恐慌贪婪指数 (Fear & Greed)。
*   **更新机制**: 后端 `fetch_onchain_and_news.py` 定时爬取生成快照。

### Tab 2: AI 跟单 (AI Copy Trading)
*   **定位**：量化交易操作台，展示 AI 的决策结果和账户表现。
*   **核心数据源**：`agent_decision_log.json` + `portfolio/nav` 文件。
*   **关键字段**：
    *   **AI 决策**: 包含分析摘要 (`analysis_summary`) 和 具体操作 (`actions`)。
    *   **账户数据**: 净值、持仓盈亏、交易历史。
    *   **决策输入**: **(目前隐性)** AI 在决策时读取了 Tab 1 的 `snapshot.json` 和自己的 Qlib 模型数据，但前端只展示了最终的“决策摘要”。

---

## 2. 差异性分析 (The Gap)

| 特性 | Tab 1 (市场分析) | Tab 2 (AI 跟单) | 差异点 |
| :--- | :--- | :--- | :--- |
| **数据视角** | **市场观察者** (上帝视角) | **交易执行者** (第一人称) | Tab 1 关注“发生了什么”，Tab 2 关注“我做了什么”。 |
| **数据时间点** | **实时刷新** (每30秒获取最新快照) | **事件驱动** (每4小时做一次决策) | 用户在 Tab 1 看到的是 20:30 的新闻，但 Tab 2 显示的可能是 20:00 做决策时的状态。这是合理的，但也可能导致困惑。 |
| **关联性展示** | 无 | 弱关联 (仅在文字摘要中提及) | AI 说“因为恐慌指数低所以买入”，但 Tab 2 界面上没有直接显示当时的恐慌指数数值。 |
| **标的覆盖** | ETH, SOL 重点展示 | BTC 为主 (策略基准) | 品种侧重不同。 |

---

## 3. 合并方案：构建“数据总线 (Data Bus)”

为了让用户感觉到“AI 确实是看着 Tab 1 的数据在做交易”，我们需要打通两个环节。

### 方案 A：显性关联 (前端融合) —— **推荐**
**目标**：在 Tab 2 的“AI 决策日志”中，显示当时的 Tab 1 关键指标。

**实施步骤**：
1.  **后端升级**：修改 `DeepSeek_Agent.py`，在生成决策日志 (`agent_decision_log.json`) 时，不仅存 `analysis_summary`，还要把当时的 **核心市场快照** (Fear Index, Top News Title, Liquidation Amount) 存进去。
    *   *现有代码中已经存了 `market_indicators_at_time` (Qlib数据)，只需把 `global_snapshot` 的核心字段也加进去。*
2.  **前端展示**：在 Tab 2 点击某条决策记录时，展开显示一个 **"Decision Context" (决策上下文)** 小卡片：
    *   "决策时的恐慌指数: 25 (Extreme Fear)"
    *   "决策时的头条新闻: [SEC批准ETF...]"
    *   "决策时的全网爆仓: $1.2B"

### 方案 B：统一入口 (后端重构)
**目标**：强行让两个 Tab 读取同一个聚合 API。

**实施步骤**：
1.  创建一个新的聚合 API `/api/unified-dashboard`。
2.  该 API 返回 `{ market_scan: ..., ai_trading: ... }`。
3.  前端重构，Tab 1 只是展示 `market_scan` 部分，Tab 2 展示 `ai_trading` 部分。
*   **评价**：工程量大，且意义不大，因为两个页面的刷新频率本质不同（市场数据需要高频刷新，交易决策是低频的）。

## 4. 结论与建议

您目前的架构已经是 **Data Bus 模式的雏形**（后端共享了 `snapshot.json`）。

**建议执行方案 A**：
不需要重写架构，只需要在 AI **保存日志的那一刻**，把“案发现场的数据”截图保存下来，并传给前端展示。这样用户就能完美地将 Tab 1 的知识与 Tab 2 的行动对应起来。
